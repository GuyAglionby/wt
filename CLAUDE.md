# wt

Single-file bash tool (`wt`) for managing git worktrees.

## Worktree resolution helpers

All worktree/branch lookups must go through the existing helper functions. Never reimplement this logic inline.

- `get_worktree_path(repo_root, branch)` -- derives the directory path for a branch's worktree (`{parent}/worktree--{repo}--{branch}`)
- `normalize_branch(branch)` -- strips the `worktree--*--` directory prefix to recover a plain branch name
- `find_worktree_for_branch(repo_root, branch)` -- looks up a worktree path by branch name (parses `git worktree list --porcelain`)
- `find_branch_for_worktree(repo_root, worktree_path)` -- reverse lookup: branch name from worktree path
- `resolve_worktree(arg, repo_root)` -- accepts either a path or branch name and returns the validated worktree path. This is the main entry point used by commands.

Any new command that accepts a branch or worktree argument should call `resolve_worktree`, not hand-roll its own validation.

## Shell IPC signals

`wt` runs as a subprocess, so it cannot directly `cd` the user's shell or activate a virtualenv. Instead, commands emit signal lines on stdout:

- `__WT_CD__:<path>` -- tells the shell wrapper to `cd` to the given path
- `__WT_ACTIVATE__:<path>` -- tells the shell wrapper to activate the venv at that path

The shell wrapper function (generated by `wt init`) parses these signals and acts on them. Any new command that needs to change the shell's working directory or environment must use these signals rather than attempting to `cd` or `source` directly.

## Metadata storage

Per-worktree metadata lives in `.git/worktrees/{worktree_name}/`:

- `starting_commit` -- the commit HEAD pointed to when the worktree was created (via `cmd_add`). Used by the branch deletion heuristic.
- `agent_base/` -- snapshot of agent files at worktree creation time, used for three-way merge on sync.

`worktree_name` is obtained via `get_worktree_name()`.

## Branch deletion heuristic

When removing a worktree (`_rm_single`), the branch is only auto-deleted if its HEAD still equals the recorded `starting_commit` (i.e., no new commits were made). If the branch has diverged, it's retained. This prevents accidental data loss. `--force-delete-branch` overrides the heuristic.

## Bash compatibility

Target is bash 3.2 (macOS system bash). Do not use bash 4+ features:

- No associative arrays (`declare -A`, `local -A`)
- No `readarray` / `mapfile`
- No `${var,,}` / `${var^^}` case conversion
- No `|&` (pipe stderr)
- No negative array indexing (`${arr[-1]}`)

For set-membership lookups, store newline-delimited strings and use `grep -qxF`.

## Environment management

Worktrees depend on the main repo, never on each other. The main worktree outlives all linked worktrees, so sharing its resources (venv, .env) is safe. A worktree's own resources are ephemeral â€” other worktrees must not reference them.

`_create_venv()` is the single entry point for creating a standalone venv. Both `cmd_add` (when the source has its own venv) and `cmd_venv` use it. Future package manager support (poetry) should be added here.

## Command naming

- User-facing commands: `cmd_<name>()`
- Internal helpers: `_<name>()`
